workflow:
  - step:
      name: switch-master
      command: ["tasks", "apply"]
      with:
        tasks:
          - name: "Switch to master"
            actions:
              - type: branch.change
                options:
                  branch: master
                  remote: origin
                  create_if_missing: false
                  capture:
                    name: initial_branch
                    value: branch

  - step:
      name: gitignore-branch
      after: ["switch-master"]
      command: ["tasks", "apply"]
      with:
        tasks:
          - name: "Create automation branch"
            actions:
              - type: branch.change
                options:
                  branch: "automation/gitignore/{{ .Repository.Name }}-{{ index .Environment \"workflow_run_id\" }}"
                  remote: origin
                  create_if_missing: true

  - step:
      name: gitignore-apply
      after: ["gitignore-branch"]
      command: ["tasks", "apply"]
      with:
        tasks:
          - name: "Ensure gitignore entries"
            safeguards:
              hard_stop:
                require_clean:
                  enabled: true
                  ignore_dirty_paths:
                    - ".env"
                    - ".env.*"
                    - ".DS_Store"
                    - "qodana.yaml"
                    - ".idea/"
                    - "tools/"
                    - "bin/"
              soft_skip:
                paths:
                  - ".gitignore"
            steps:
              - files.apply
            files:
              - path: .gitignore
                content: |
                  # Managed by gix gitignore workflow
                  .env
                  .env.*
                  .DS_Store
                  qodana.yaml
                  .idea/
                  tools/
                  bin/
                mode: append-if-missing

  - step:
      name: gitignore-stage-commit
      after: ["gitignore-apply"]
      command: ["git", "stage-commit"]
      with:
        paths:
          - ".gitignore"
        commit_message: "chore: ensure gitignore entries"

  - step:
      name: gitignore-open-pr
      after: ["gitignore-stage-commit"]
      command: ["pull-request", "open"]
      with:
        branch: "automation/gitignore/{{ .Repository.Name }}-{{ index .Environment \"workflow_run_id\" }}"
        title: "chore({{ .Repository.Name }}): ensure gitignore entries"
        body: |
          Ensure `.gitignore` contains the standard secrets/tooling entries (.env, tools/, bin/).
        base: "{{ .Repository.DefaultBranch }}"
        push_remote: origin

  - step:
      name: restore-original-state
      after: ["gitignore-open-pr"]
      command: ["tasks", "apply"]
      with:
        tasks:
          - name: "Restore initial branch"
            actions:
              - type: branch.change
                options:
                  restore:
                    from: initial_branch
                    value: branch
