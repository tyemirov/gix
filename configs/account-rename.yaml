workflow:
  - step:
      name: remotes
      command: ["remote", "update-to-canonical"]

  - step:
      name: folders
      after: ["remotes"]
      command: ["folder", "rename"]
      with:
        include_owner: true
        require_clean: false

  - step:
      name: protocol-to-git-https
      after: ["folders"]
      command: ["remote", "update-protocol"]
      with:
        from: https
        to: git

  - step:
      name: protocol-to-git-ssh
      after: ["folders"]
      command: ["remote", "update-protocol"]
      with:
        from: ssh
        to: git

  - step:
      name: switch-branch
      after: ["protocol-to-git-https", "protocol-to-git-ssh"]
      command: ["tasks", "apply"]
      with:
        tasks:
          - name: "Switch to master"
            safeguards:
              hard_stop:
                require_clean:
                  enabled: true
            actions:
              - type: branch.change
                options:
                  branch: master
                  remote: origin
                  create_if_missing: false
                  capture:
                    name: initial_branch
                    value: branch

  - step:
      name: namespace-branch
      after: ["switch-branch"]
      command: ["tasks", "apply"]
      with:
        tasks:
          - name: "Create namespace branch"
            actions:
              - type: branch.change
                options:
                  branch: "automation/ns-rewrite/{{ .Repository.Name }}-{{ index .Environment \"workflow_run_id\" }}"
                  remote: origin
                  create_if_missing: true

  - step:
      name: namespace-rewrite
      after: ["namespace-branch"]
      command: ["tasks", "apply"]
      with:
        tasks:
          - name: "Rewrite module namespace"
            steps:
              - files.apply
            files:
              - path: go.mod
                mode: replace
                replacements:
                  - from: github.com/temirov
                    to: github.com/tyemirov
              - path: go.sum
                mode: replace
                replacements:
                  - from: github.com/temirov
                    to: github.com/tyemirov
              - path: "**/*.go"
                mode: replace
                replacements:
                  - from: github.com/temirov
                    to: github.com/tyemirov
              - path: README.md
                mode: replace
                replacements:
                  - from: temirov
                    to: tyemirov
              - path: "docs/**/*.md"
                mode: replace
                replacements:
                  - from: temirov
                    to: tyemirov

  - step:
      name: namespace-stage-commit
      after: ["namespace-rewrite"]
      command: ["git", "stage-commit"]
      with:
        paths:
          - "."
        commit_message: "refactor: rewrite module namespace after owner rename"
        safeguards:
          soft_skip:
            require_changes: true

  - step:
      name: namespace-push
      after: ["namespace-stage-commit"]
      command: ["git", "push"]
      with:
        branch: "automation/ns-rewrite/{{ .Repository.Name }}-{{ index .Environment \"workflow_run_id\" }}"
        push_remote: origin
        safeguards:
          soft_skip:
            require_changes: true

  - step:
      name: namespace-open-pr
      after: ["namespace-push"]
      command: ["pull-request", "open"]
      with:
        branch: "automation/ns-rewrite/{{ .Repository.Name }}-{{ index .Environment \"workflow_run_id\" }}"
        title: 'refactor({{ .Repository.Name }}): rewrite module namespace'
        body: |
          Rewrites Go module imports from `github.com/temirov` to `github.com/tyemirov` after the owner rename.
        base: "{{ .Repository.DefaultBranch }}"
        push_remote: origin
        safeguards:
          soft_skip:
            require_changes: true

  - step:
      name: restore-original-state
      after: ["namespace-open-pr"]
      command: ["tasks", "apply"]
      with:
        tasks:
          - name: "Restore initial branch"
            actions:
              - type: branch.change
                options:
                  restore:
                    from: initial_branch
                    value: branch

  - step:
      name: namespace-branch-cleanup
      after: ["restore-original-state"]
      command: ["git", "branch-cleanup"]
      with:
        branch: "automation/ns-rewrite/{{ .Repository.Name }}-{{ index .Environment \"workflow_run_id\" }}"
        base: "{{ .Repository.DefaultBranch }}"
